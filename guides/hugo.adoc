:hugo: ssg
:ssg: Hugo
:ssgl: hugo
:ssgext: hugo.html
:toc:
:toclevels: 3
:toc-placement!:

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :star2:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

= The Complete {ssg} Bookshop Guide

toc::[]

== Concepts

Bookshop defines conventions for writing static components for {ssg}. Using these conventions, Bookshop provides an ergonomic way to build pages out of your components, build and browse these components locally, and generate rich live editing experiences in CloudCannon.

By the end of this guide, we will have:

* A component-driven page-builder website
* A local component browser and playground
* Automatic creation of CloudCannon structured data for your components
* Live contextual editing for your editors in CloudCannon

For an example of what this looks like in a real-world example, see our link:https://vimeo.com/689852104[Hugo Bookshop MegaKit] template.

== Prerequisites

// Environment Prerequisites

* Bookshop requires Node >= 14 installed on your machine.
ifeval::["{ssg}" == "Hugo"]
* Since Hugo Bookshop utilizes the Hugo module system, the link:https://go.dev/doc/install[Go Programming Language] needs to be installed on your machine.
endif::[]

// END Environment Prerequisites

== Starting Point

TIP: Short on time? You can use our link:https://github.com/CloudCannon/{ssgl}-bookshop-starter/[{ssg} Bookshop Starter Template] and jump straight into editing it in CloudCannon. Come back here when you want to build it out further, or create your own from scratch.

This guide will walk you through getting Bookshop connected to an existing {ssg} site. If you don't have a site already, 
ifeval::["{ssg}" == "Hugo"]
running link:https://gohugo.io/getting-started/quick-start/#step-2-create-a-new-site[`hugo new site`] is a good start.
endif::[]
ifeval::["{ssg}" == "Jekyll"]
running link:https://jekyllrb.com/docs/[`jekyll new`] is a good start.
endif::[]
Alternatively, grab one of our preconfigured link:https://cloudcannon.com/community/themes/[{ssg} templates].

== Creating your Bookshop

The first step is to create the directory structure for your Bookshop. To create this structure, you can run the following command in the root of your repository:

`npx @bookshop/init --new component-library --framework {ssgl}`

This command should provide you with the following directory structure:

// Initial Bookshop Structure

[source,text,subs="attributes"]
----
component-library/
ifeval::["{ssg}" == "Hugo"]
├─ config.toml
endif::[]
├─ bookshop/
│  └─ bookshop.config.js
├─ components/
│  └─ sample/
│     ├─ sample.bookshop.<format>
│     ├─ sample.scss
│     └─ sample.{ssgext}
└─ shared/
   ├─ {ssgl}
   │  └─ page.{ssgext}
   └─ styles/
      └─ globals.scss
----

Here's a quick run-through of what has been generated:

ifeval::["{ssg}" == "Hugo"]
config.toml:: This file registers your component library as a Hugo Module. This will allow us to use it as a dependency for your site.
endif::[]
bookshop/bookshop.config.js:: This houses the configuration for your Bookshop project, in this case instructing Bookshop to use the `@bookshop/{ssgl}-engine` package for any live component rendering.
components/:: This is where you will write your component files.
shared/{ssgl}/:: Any non-component files that you want to be able to use when live rendering can be placed here.
shared/styles/:: Any SCSS files in this directory will be imported alphabetically before component SCSS files.

// END Initial Bookshop Structure

'''

// Bookshop File Reference Guide

Creating these files yourself?
++++
<details><summary>Bookshop File Reference</summary>
++++

ifeval::["{ssg}" == "Hugo"]
.*component-library/config.toml*
[source,toml,subs="attributes"]
----
[module]
hugoVersion.extended = true
hugoVersion.min = "0.86.1"

[[module.mounts]]
source = "."
target = "layouts/partials/bookshop"

[[module.mounts]]
source = "."
target = "assets/bookshop"
----
endif::[]

.*component-library/bookshop/bookshop.config.js*
[source,javascript,subs="attributes"]
----
module.exports = {
    engines: {
        "@bookshop/{ssgl}-engine": {}
    }
}
----

We'll cover creating components and shared files later on.

++++
</details>
++++

// END Bookshop File Reference Guide

== Connecting Your Bookshop to {ssg}

// Bookshop Plugins and Setup

ifeval::["{ssg}" == "Hugo"]

Bookshop is distributed as a Hugo Module, so the first step is to make sure that your Hugo site is set up for the Hugo Module system. If there isn't a `go.mod` file in your site root, run `hugo mod init site.local` to initialize this.

With your site ready, we need to pull in the primary dependency of `bookshop/hugo`, as well as the component library we just created.

The following should be placed in your Hugo site config (usually `config.toml` in your root folder).

.*site/config.toml*
[source,toml,subs="attributes"]
----
[module]
replacements = "components.local -> ../component-library"

[[module.imports]]
path = 'components.local'

[[module.imports]]
path = 'github.com/cloudcannon/bookshop/hugo/v3'
----

Adjust the `../component-library` path in `replacements` if you created it with a different name, or in a different place.

TIP: This path is relative to the Hugo `themes` directory (whether or not it exists), hence why it is `../component-library` rather than `component-library` in this instance.

With that configuration in place, running `hugo serve` should download the required module and host your site. Nothing will appear different yet, but we now have access to use components.

endif::[]

Lastly, we'll need to install a few npm packages for Bookshop. These should be installed at the root of the repository that contains your site. If this folder doesn't have a `package.json` file yet, run `npm init` to create one.

To get setup, run the following command to install the needed Bookshop packages:
[source,bash,subs="attributes"]
----
# npm
npm i --save-exact @bookshop/generate @bookshop/browser @bookshop/{ssgl}-engine

# yarn
yarn add --exact @bookshop/generate @bookshop/browser @bookshop/{ssgl}-engine
----

IMPORTANT: Bookshop uses a fixed versioning scheme, where all packages are released for every version. It is recommended that you keep the npm packages and your plugins at the same version. To help with this, you can run `npx @bookshop/up@latest` from your repository root to update all Bookshop packages in sync.

// END Bookshop Plugins and Setup

== Using Components in {ssg}

// File Naming Info

If you ran the `@bookshop/init` command earlier, you should see that you now have a file at `components/sample/sample.{ssgext}`. Let's have a go using that component somewhere on our site.

TIP: Bookshop supports multiple SSG targets, which is why we denote this as `.{ssgext}`.

// END File Naming Info

// Bookshop Templating Tags

ifeval::["{ssg}" == "Hugo"]

Bookshop provides a range of partials which we will cover. The most important of these is the default `bookshop` partial that we will use to access our components. 

To start, add the following snippet to one of your layouts:

.*index.html*
[source,go,subs="attributes"]
----
...

{{ partial "bookshop" (slice "sample" (dict "text" "Hello World")) }}

...
----

This partial expects a slice where the first element is the **Bookshop key** of a component, and the second element contains the arguments to that component.

TIP: The **Bookshop key** of a component is the path to its directory. +
So the key for `components/sample/sample.hugo.html` is `sample`, +
and the key for `components/generic/button/button.hugo.html` would be `generic/button`.

If you now load your Hugo site in a browser, you should see the sample component rendered on the page. There won't be any styles yet, we'll cover that soon. First though, there are a few neater ways you can use the `bookshop` partial:

=== Alternate syntax

Writing a Hugo `dict` by hand can be cumbersome, and these will often point to front matter objects. If you have the front matter:

.*index.md*
[source,yaml,subs="attributes"]
----
sample:
  text: Hello World
----

Then you can replace the partial we just wrote with the following: 

.*index.html*
[source,go,subs="attributes"]
----
...

{{ partial "bookshop" (slice "sample" .Params.sample) }}

...
----

To go one step further, you can add the key `_bookshop_name` to this object:

.*index.md*
[source,yaml,subs="attributes"]
----
sample:
  _bookshop_name: sample
  text: Hello World
----

Which lets us pass the object directly to the `bookshop` partial: 

.*index.html*
[source,go,subs="attributes"]
----
...

{{ partial "bookshop" .Params.sample }}

...
----

TIP: The `_bookshop_name` will usually be created for you by Bookshop. We'll cover how Bookshop generates structured data a bit later on.

// endif::Hugo
endif::[]

=== Using Shared Bookshop Helpers in {ssg}

Shared Bookshop helpers can be places in the `shared/{ssgl}` directory. i.e:
[source,text,subs="attributes"]
----
component-library/
├─ components/
└─ shared/
  └─ {ssgl}/
    └─ helper.{ssgext}
----

ifeval::["{ssg}" == "Hugo"]
This can then be included using the `bookshop_partial` partial:
```html
  {{ partial "bookshop_partial" (slice "helper" (dict "lorem" "ipsum")) }}
```

The arguments are the same as the `bookshop` partial. This is otherwise a standard Hugo partial, with the extra feature that it can be used anywhere within your Hugo site _or_ your components.
endif::[]

You will notice that `@bookshop/init` created a `page.{ssgext}` file for you. Given the following front matter:

```yaml
content_blocks:
  - _bookshop_name: hero
    title: Hello World
    image: /image.png
  - _bookshop_name: cta
    heading: Join our newsletter
    location: /signup
```

You can render the array of components using the page helper like so:

ifeval::["{ssg}" == "Hugo"]

```html
  {{ partial "bookshop_partial" (slice "page" .Params.content_blocks) }}
```

endif::[]

This will loop through the given array, and render each component according to its `_bookshop_name` key.

IMPORTANT: It is highly recommended to render arrays of components using the page helper. Live editing only works within Bookshop components and helpers, so using this method means that rearranging and adding new components will work in the Visual Editor.

// END Bookshop Templating Tags

== Importing Bookshop Styles

Bookshop provides some helpers for including the component and global styles that you defined in your component library. 

NOTE: Locating styles here is optional — you can always define them with the rest of your site — but authoring your styles in your component library will provide a better experience when we cover using the local component browser.

// Bookshop Style Tags

ifeval::["{ssg}" == "Hugo"]

To include all of your Bookshop styles in Hugo, you can use the `bookshop_scss` partial in your `baseof.html` layout. This partial returns a slice of all SCSS files, which can then be included into your existing Hugo resource pipeline:

.*baseof.html*
```html
{{ $bookshop_scss_files := partial "bookshop_scss" . }}
{{ $scss := $bookshop_scss_files | resources.Concat "css/bookshop.css" | resources.ToCSS | resources.Minify |
    resources.Fingerprint }}
<link rel="stylesheet" href="{{ $scss.Permalink }}">
```

// endif::Hugo
endif::[]

// END Bookshop Style Tags

IMPORTANT: Bookshop SCSS files are returned as all shared files, followed by all component files, alphabetically.

== Authoring New Components

TIP: To create new components, you can simply run `npx @bookshop/init --component <name>`

Components live within the `components/` directory, each inside a folder bearing their name. A component is defined with a `<name>.bookshop.<format>` file. This file serves as the schema for the component, defining which properties it may be supplied.

Components may also be nested within folders, which are then referenced as part of the component name. For example, the following structure would define the components `hero`, `button/large` and `button/small`:

[source,text,subs="attributes"]
----
components/
├─ hero/
|  |  hero.bookshop.yml
|  └─ hero.{ssgext}
└─ button/
   ├─ large/
   |  |  large.bookshop.yml
   │  └─ large.{ssgext}
   └─ small/
   |  |  small.bookshop.yml
      └─ small.{ssgext}
----

=== Authoring Component Template Files

Beyond the naming convention, Bookshop template files are what you would expect when writing a file for {ssg}. A basic button component might look like the following:

.*components/button/button.{ssgext}*
ifeval::["{ssg}" == "Hugo"]
[source,go]
----
<a class="c-button" href="{{ .link_url }}">{{ .link_text }}</a>
----
endif::[]

Components can, of course, reference other components:

.*components/hero/hero.{ssgext}*
ifeval::["{ssg}" == "Hugo"]
[source,go]
----
<h1>{{ .title }}</h1>
{{ partial "bookshop" (slice "button" (dict "link_url" .url "link_text" "Click me")) }}
----
endif::[]

=== Authoring Component Styles

A `<component>.scss` file can be written alongside your other component files. Beyond the location and the automatic import, there is nothing special about the contents of this file.

=== Authoring Component Bookshop Files

The Bookshop file for each component is the most important piece of the Bookshop ecosystem. This file drives the Structured Data in CloudCannon, the local component browser, and Bookshop's live editing. +
The `sample.bookshop.yml` file that our init command generated contains the following:

++++
<details><summary>sample.bookshop.yml</summary>
++++


```yaml
# Metadata about this component, to be used in the CMS
spec:
  structures:
    - content_blocks
  label: Sample
  description: A sample component to get you started with Bookshop
  icon: book
  tags: []

# Defines the structure of this component, as well as the default values
blueprint:
  text: Sample Text

# Overrides any fields in the blueprint when viewing this component in the component browser
preview:
  title: Vestibulum id ligula porta felis euismod semper.

# Any extra CloudCannon inputs configuration to apply to the blueprint
_inputs: {}
```

++++
</details>
++++

Let's walk through this file section by section to understand what's going on.

==== Component Spec

```yaml
spec:
  structures:
    - content_blocks
  label: Sample
  description: A sample component to get you started with Bookshop
  icon: book
  tags:
    - example
```

This section is used when creating the link:https://cloudcannon.com/documentation/articles/defining-what-adds-to-an-array-with-array-structures/?ssg={ssg}#structures[Structure] for your component. The `structures` array defines which structure keys to register this component with. In other words, with the above snippet, this component will be one of the options within an array named `content_blocks`, or another input configured to use `_structures.content_blocks`.

The other keys are used when the component is displayed in CloudCannon or in the Bookshop Component Browser. `icon` should be the name of a suitable link:https://strict-hanger.cloudvent.net/[material icon] to use as the thumbnail for your component.

==== Component Blueprint

```yaml
blueprint:
  text: Sample Text
```

The blueprint is the primary section defining your component. This will be used as the intitial state for your component when it is added to a page, and should thus include all properties used in your template.

==== Component Preview

```yaml
preview:
  title: Vestibulum id ligula porta felis euismod semper.
```

Oftentimes your blueprint will represent the blank state of your component, so that editors don't have to remove content when adding a new component to the page. This can hinder your experience with the component browser, where you want to see a preview of your component in a real-world use-case.

The preview object will be merged with your blueprint before a component is rendered in the component browser. This is a deep merge, so given the following specification:

```yaml
blueprint:
  title: "Hello World"
  cta:
    button_text: ""
    button_url: "#"

preview:
  cta:
    button_text: "Click me"
```

Your component preview data will be:

```yaml
title: "Hello World"
cta:
  button_text: "Click me"
  button_url: "#"
```

NOTE: In a future Bookshop release, component thumbnails will be automatically generated. This will also use the preview object.

==== Inputs Configuration

```yaml
_inputs: 
  text:
    type: "html"
    comment: "This comment will appear in the CMS"
```

The `_inputs` section of your Bookshop file can be used to configure any keys for CloudCannon. This object is passed through unaltered to CloudCannon, so see the link:https://cloudcannon.com/documentation/articles/how-to-choose-what-input-is-used-in-the-data-editor/?ssg={ssg}[CloudCannon Inputs Documentation] to read more.

This configuration is scoped to the individual component, so you can configure the same key differently across components — even if they're nested within one another.

==== Blueprint Arrays

Arrays of objects in your blueprint will be transformed into CloudCannon Structures automatically, and initialized as empty arrays. Using the following Blueprint:

```yaml
blueprint:
  text: Sample Text
  items:
    - item_content: Hello World
```

A new component added to the page will take the form:

```yaml
text: Sample Text
items: []
```

Editors will then be able to add and remove objects to the `items` array.

==== Nesting Components

Your blueprint can reference other components and structures to create rich page builder experiences:

```yaml
blueprint:
  title: Hello World
  button: bookshop:button
```

In this example, the `button` key will become an Object Structure containing the values specified in your `button` component blueprint. If you desired an array of buttons, you could use the following:

```yaml
blueprint:
  title: Hello World
  buttons: [bookshop:button]  # equivalent
  buttons:
    - bookshop:button         # equivalent
```

If you're creating a layout component, you likely want to support a set of components. For this, you can reference the keys we defined in `spec.structures` as such:

```yaml
blueprint:
  title: My Section

  # Make header a single component that can be selected from the content_blocks set
  header: bookshop:structure:content_blocks

  # Make inner_components an array of all components marked content_blocks
  inner_components: [bookshop:structure:content_blocks]
```

==== Supported File Formats

TIP: When you run `npx @bookshop/init --component <name>` you will be prompted to pick which configuration format you want to create the component with.

In the examples above, we have been writing the Bookshop configuration files using YAML. This is the recommended format, but you can also choose another if you prefer. Here is a real-world example of a component written in each supported format:

++++
<details><summary>hero.bookshop.yml</summary>
++++


```yaml
# Metadata about this component, to be used in the CMS
spec:
  structures:
    - content_blocks
    - page_sections
  label: Hero
  description: A large hero component suitable for opening a landing page
  icon: crop_landscape
  tags:
    - Above the Fold
    - Multimedia

# Defines the structure of this component, as well as the default values
blueprint:
  title: ""
  title_level: h1
  hero_image: ""
  hero_image_alt: ""

# Overrides any fields in the blueprint when viewing this component in the component browser
preview:
  title: Bookshop Makes Component Driven Development Easy
  hero_image: https://placekitten.com/600/400

# Any extra CloudCannon inputs configuration to apply to the blueprint
_inputs:
  title_level:
    type: select
    options:
      values:
        - h1
        - h2
        - h3
        - h4
```

++++
</details>
++++

++++
<details><summary>hero.bookshop.toml</summary>
++++


```toml
# Metadata about this component, to be used in the CMS
[spec]
structures = [ "content_blocks", "page_sections" ]
label = "Hero"
description = "A large hero component suitable for opening a landing page"
icon = "crop_landscape"
tags = [ "Above the Fold", "Multimedia" ]

# Defines the structure of this component, as well as the default values
[blueprint]
title = ""
title_level = "h1"
hero_image = ""
hero_image_alt = ""

# Overrides any fields in the blueprint when viewing this component in the component browser
[preview]
title = "Bookshop Makes Component Driven Development Easy"
hero_image = "https://placekitten.com/600/400"

# Any extra CloudCannon inputs configuration to apply to the blueprint
[_inputs]
title_level.type = "select"
title_level.options.values = [ "h1", "h2", "h3", "h4" ]
```

++++
</details>
++++


++++
<details><summary>hero.bookshop.js</summary>
++++


```javascript
module.exports = () => {
  const spec = {
    structures: [
      "content_blocks",
      "page_sections",
    ],
    label: "Hero",
    description: "A large hero component suitable for opening a landing page",
    icon: "crop_landscape",
    tags: [
      "Above the Fold",
      "Multimedia",
    ]
  };

  const blueprint = {
    title: "",
    title_level: "h1",
    hero_image: "",
    hero_image_alt: "",
  };

  const preview = {
    title: "Bookshop Makes Component Driven Development Easy",
    hero_image: "https://placekitten.com/600/400",
  };

  const _inputs = {
    title_level: {
      type: "select",
      options: {
        values: [
          "h1",
          "h2",
          "h3",
          "h4",
        ]
      }
    }
  };

  return {
    spec,
    blueprint,
    preview,
    _inputs,
  }
}
```

++++
</details>
++++


++++
<details><summary>hero.bookshop.json</summary>
++++


```json
{
  "spec": {
    "structures": [
      "content_blocks",
      "page_sections"
    ],
    "label": "Hero",
    "description": "A large hero component suitable for opening a landing page",
    "icon": "crop_landscape",
    "tags": [
      "Above the Fold",
      "Multimedia"
    ]
  },
  "blueprint": {
    "title": "",
    "title_level": "h1",
    "hero_image": "",
    "hero_image_alt": ""
  },
  "preview": {
    "title": "Bookshop Makes Component Driven Development Easy",
    "hero_image": "https://placekitten.com/600/400"
  },
  "_inputs": {
    "title_level": {
      "type": "select",
      "options": {
        "values": [
          "h1",
          "h2",
          "h3",
          "h4"
        ]
      }
    }
  }
}
```

++++
</details>
++++

TIP: Can't decide? You can always run `npx @bookshop/up --format <format>` to automatically convert all of your files if you change your mind.

// TODO
'''

== Connecting Bookshop to CloudCannon

NOTE: This guide assumes that your site is already set up with CloudCannon. If this isn't the case, hop over to the link:https://cloudcannon.com/documentation/articles/connecting-your-first-site/?ssg={ssg}[CloudCannon Documentation] and get setup with a successful build first.

Now that you understand how everything works locally, we can integrate Bookshop with CloudCannon. Bookshop does most of the heavy lifting for you, so we'll get to see the benefits pretty quickly. +
The main thing you need to do is create a link:https://cloudcannon.com/documentation/articles/extending-your-build-process-with-hooks/?ssg={ssg}[postbuild script] that runs Bookshop's generate script. This should be placed inside a folder named `.cloudcannon` at the root of your repository.

.*.cloudcannon/postbuild*
[source,bash,subs="attributes"]
----
npm i
npx @bookshop/generate
----

This command will automatically discover your component library, and the output site from your build. It will then hydrate your Structures for you, as well as connect live editing to any pages on your site that contain Bookshop components.

ifeval::["{ssg}" == "Hugo"]
With Hugo, there is one extra step to get live editing working. For any components or helpers in your Hugo layouts, you will need to use the `bookshop_bindings` partial to connect it to the page's front matter. 

For most setups, your site layouts will only contain the `page` helper, so this snippet will be all you need:

.*<layout>.html*
[source,go]
----
{{ partial "bookshop_bindings" `.Params.content_blocks` }}
{{ partial "bookshop" (slice "page" .Params.content_blocks) }}
----

If you're using other components in your layouts, add the `bookshop_bindings` partial to them. This partial needs to be passed a string representation of the data being passed to the component that follows it. For example:

.*<layout>.html*
[source,go]
----
{{ partial "bookshop_bindings" `(dict title .Params.title)` }}
{{ partial "bookshop" (slice "hero" (dict title .Params.title)) }}
----
endif::[]

With that in place, live editing should work in CloudCannon. If you have the following front matter on a page:

```yaml
---
content_blocks:
---
```

And the `page` helper listed above in your layout, then in the CloudCannon sidebar you should be able to add our sample component and see it render live on the page.

=== Data Bindings

Once you have components rendered on the page, Bookshop will assign link:https://cloudcannon.com/documentation/articles/what-are-visual-data-bindings/?ssg={ssg}[Visual Data Bindings] automatically, so you will be able to interact with components directly on the page.

// == Advanced

// ++++
// <details><summary>Keeping your Bookshop in a seperate repository</summary>
// ++++

// TODO

// ++++
// </details>
// ++++